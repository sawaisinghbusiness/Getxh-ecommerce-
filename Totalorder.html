<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Order - GETXH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f5f6fa; }
    </style>
</head>

<body class="min-h-screen">

<!-- Navbar -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="Dashboard.html" class="text-2xl font-bold text-blue-600">GETXH</a>

            <div class="hidden md:flex items-center space-x-8">
                <a href="Dashboard.html">Dashboard</a>
                <a href="Neworder.html" class="text-blue-600 font-semibold border-b-2 border-blue-600 pb-1">New Order</a>
                <a href="Totalorder.html">Orders</a>
                <a href="Support.html">Support</a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <h1 class="text-3xl font-bold text-gray-800 mb-6">Place New Order</h1>

    <div class="bg-white rounded-xl shadow-md p-6 sm:p-8 max-w-4xl mx-auto mb-8">
        <form id="orderForm">

            <input type="text" id="searchService" placeholder="Search for a service..."
                class="w-full px-4 py-3 border mb-6 rounded-lg">

            <label class="font-semibold">Category</label>
            <select id="categorySelect"
                class="w-full px-4 py-3 border rounded-lg mb-6">
                <option value="">Select a category</option>
                <option value="Instagram Followers">Instagram Followers</option>
                <option value="Instagram Reel Views">Instagram Reel Views</option>
                <option value="Instagram Likes">Instagram Likes</option>
                <option value="Instagram Indian Likes">Instagram Indian Likes</option>
            </select>

            <label class="font-semibold">Service</label>
            <select id="serviceSelect"
                class="w-full px-4 py-3 border rounded-lg mb-6" disabled>
                <option value="">Select a service</option>
            </select>

            <div id="serviceDetails" class="hidden p-4 border bg-gray-50 rounded-lg mb-6">
                <h3 class="font-semibold mb-2">Service Details</h3>
                <p id="serviceDescription" class="text-sm mb-2"></p>
                <p class="text-xs">Cancel: <span id="serviceCancel"></span></p>
                <p class="text-xs">Drop: <span id="serviceDrop"></span></p>
                <p class="text-xs">Quality: <span id="serviceQuality"></span></p>
            </div>

            <label class="font-semibold">Link</label>
            <input type="text" id="linkInput" class="w-full px-4 py-3 border rounded-lg mb-6">

            <label class="font-semibold">Quantity</label>
            <p id="minMaxText" class="text-sm text-gray-500 mb-2">Min: 0 – Max: 0</p>
            <input type="number" id="quantityInput"
                class="w-full px-4 py-3 border rounded-lg mb-1">
            <p id="quantityError" class="text-sm text-red-600 hidden mb-4">Invalid quantity</p>

            <div class="p-4 bg-gray-50 rounded-lg border mb-6 flex justify-between">
                <span class="font-semibold">Total Price</span>
                <span id="totalPrice" class="text-xl font-bold text-blue-600">₹0.00</span>
            </div>

            <button id="placeOrderBtn" class="w-full bg-blue-600 text-white py-4 rounded-lg disabled:bg-gray-300"
                disabled>Place Order</button>

        </form>
    </div>

    <!-- Recent Orders -->
    <div class="bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto">
        <h3 class="text-xl font-bold mb-4">Your Recent Orders</h3>
        <div id="recentOrdersContainer"></div>
        <a href="Totalorder.html" class="text-blue-600 block text-right mt-4">View all orders →</a>
    </div>

</div>

<!-- Success Modal -->
<div id="successModal"
     class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
        <div class="text-center mb-4">
            <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor">
                    <path stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold">Order placed</h3>
        </div>

        <div class="flex gap-3">
            <button onclick="location.href='Totalorder.html'"
                class="flex-1 bg-blue-600 text-white py-3 rounded-lg">
                View Orders
            </button>
            <button id="closeModalBtn"
                class="flex-1 bg-gray-200 py-3 rounded-lg">
                Close
            </button>
        </div>
    </div>
</div>

<!-- FIREBASE + LOGIC -->
<script type="module">

// FIREBASE IMPORT
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
    getFirestore, collection, addDoc, getDocs, query, orderBy, limit 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyClO8clBVgSHKx8jarNwC38oMtWRK0W8KE",
  authDomain: "getxh-42588.firebaseapp.com",
  projectId: "getxh-42588",
  storageBucket: "getxh-42588.firebasestorage.app",
  messagingSenderId: "170770122888",
  appId: "1:170770122888:web:7adcf91077d5695b06b73d"
};

// INIT
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// CURRENT USER UID
let currentUid = null;

onAuthStateChanged(auth, user => {
    if (!user) {
        location.href = "index.html";
    } else {
        currentUid = user.uid;
        loadRecentOrders();
    }
});


// ---------------- SERVICES DATA ----------------
const servicesData = [
    { serviceId:"IF001", serviceName:"Followers Normal", category:"Instagram Followers", pricePer1000:169, minQuantity:100, maxQuantity:1000000, description:"High quality", cancel:"No", drop:"Low", quality:"High" },
    { serviceId:"IRV001", serviceName:"Reel Views Real", category:"Instagram Reel Views", pricePer1000:0.36, minQuantity:100, maxQuantity:2000000, description:"Real views", cancel:"Yes", drop:"No", quality:"Real" },
    { serviceId:"IL001", serviceName:"Likes Normal", category:"Instagram Likes", pricePer1000:27, minQuantity:10, maxQuantity:100000, description:"Real likes", cancel:"No", drop:"Low", quality:"High" }
];

// DOM ELEMENTS
const searchService = document.getElementById("searchService");
const categorySelect = document.getElementById("categorySelect");
const serviceSelect = document.getElementById("serviceSelect");
const serviceDetails = document.getElementById("serviceDetails");
const serviceDescription = document.getElementById("serviceDescription");
const serviceCancel = document.getElementById("serviceCancel");
const serviceDrop = document.getElementById("serviceDrop");
const serviceQuality = document.getElementById("serviceQuality");
const linkInput = document.getElementById("linkInput");
const quantityInput = document.getElementById("quantityInput");
const minMaxText = document.getElementById("minMaxText");
const quantityError = document.getElementById("quantityError");
const totalPrice = document.getElementById("totalPrice");
const placeOrderBtn = document.getElementById("placeOrderBtn");
const recentOrdersContainer = document.getElementById("recentOrdersContainer");
const successModal = document.getElementById("successModal");
document.getElementById("closeModalBtn").onclick = () => successModal.classList.add("hidden");


let selectedService = null;


// ---------------- SERVICE SELECT UPDATE ----------------
function updateServiceSelect() {
    const category = categorySelect.value;
    const term = searchService.value.toLowerCase();

    serviceSelect.innerHTML = `<option value="">Select a service</option>`;

    if (!category) { serviceSelect.disabled = true; return; }

    const filtered = servicesData.filter(s =>
        s.category === category &&
        s.serviceName.toLowerCase().includes(term)
    );

    filtered.forEach(s => {
        const op = document.createElement("option");
        op.value = s.serviceId;
        op.textContent = `${s.serviceName} – ₹${s.pricePer1000} per 1000`;
        serviceSelect.appendChild(op);
    });

    serviceSelect.disabled = filtered.length === 0;
}

searchService.oninput = updateServiceSelect;
categorySelect.onchange = () => { updateServiceSelect(); resetService(); };


// ---------------- SERVICE DETAILS ----------------
serviceSelect.onchange = () => {
    selectedService = servicesData.find(s => s.serviceId === serviceSelect.value);

    if (!selectedService) return;

    serviceDetails.classList.remove("hidden");
    serviceDescription.textContent = selectedService.description;
    serviceCancel.textContent = selectedService.cancel;
    serviceDrop.textContent = selectedService.drop;
    serviceQuality.textContent = selectedService.quality;

    minMaxText.textContent =
        `Min: ${selectedService.minQuantity} – Max: ${selectedService.maxQuantity}`;

    quantityInput.value = "";
    totalPrice.textContent = "₹0.00";
};


// ---------------- PRICE CALCULATION ----------------
quantityInput.oninput = () => {
    if (!selectedService) return;

    let qty = parseInt(quantityInput.value);

    if (!qty ||
        qty < selectedService.minQuantity ||
        qty > selectedService.maxQuantity
    ) {
        quantityError.classList.remove("hidden");
        placeOrderBtn.disabled = true;
        totalPrice.textContent = "₹0.00";
        return;
    }

    quantityError.classList.add("hidden");

    let price = (qty / 1000) * selectedService.pricePer1000;
    totalPrice.textContent = `₹${price.toFixed(2)}`;

    placeOrderBtn.disabled = false;
};


// ---------------- SAVE ORDER TO FIREBASE ----------------
async function saveOrder(service, qty, link, price) {
    const col = collection(db, "orders", currentUid, "user_orders");

    const now = new Date();

    await addDoc(col, {
        serviceId: service.serviceId,
        serviceName: service.serviceName,
        category: service.category,
        quantity: qty,
        link: link,
        price: parseFloat(price),
        status: "Processing",
        createdAt: now.toISOString(),
        createdAtReadable: now.toLocaleString()
    });
}


// ---------------- PLACE ORDER ----------------
placeOrderBtn.onclick = async (e) => {
    e.preventDefault();
    if (!selectedService) return;

    let qty = parseInt(quantityInput.value);
    let link = linkInput.value.trim();
    let price = totalPrice.textContent.replace("₹","");

    if (!qty || !link) return;

    await saveOrder(selectedService, qty, link, price);

    linkInput.value = "";
    quantityInput.value = "";
    resetService();

    successModal.classList.remove("hidden");

    loadRecentOrders();
};


// ---------------- RESET SERVICE ----------------
function resetService() {
    selectedService = null;
    serviceDetails.classList.add("hidden");
    quantityInput.value = "";
    totalPrice.textContent = "₹0.00";
    placeOrderBtn.disabled = true;
}


// ---------------- LOAD RECENT ORDERS ----------------
async function loadRecentOrders() {
    if (!currentUid) return;

    const col = collection(db, "orders", currentUid, "user_orders");
    const q = query(col, orderBy("createdAt", "desc"), limit(3));
    const snap = await getDocs(q);

    if (snap.empty) {
        recentOrdersContainer.innerHTML =
            "<p class='text-gray-500 text-sm'>No recent orders.</p>";
        return;
    }

    recentOrdersContainer.innerHTML = "";

    snap.forEach(doc => {
        const o = doc.data();

        const div = document.createElement("div");
        div.className = "p-4 bg-gray-50 border rounded-lg mb-3";

        div.innerHTML = `
            <p class="font-semibold">${o.serviceName}</p>
            <p class="text-xs text-gray-600">Qty: ${o.quantity}</p>
            <p class="text-xs text-gray-600">₹${o.price}</p>
            <p class="text-xs text-gray-500">${o.createdAtReadable}</p>
        `;

        recentOrdersContainer.appendChild(div);
    });
}

</script>

</body>
</html>
